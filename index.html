<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>IHS2 ‚Äî Invent√°rio de Habilidades Sociais</title>
<style>
  :root{
    --bg:#f1f5f9;
    --card:#ffffff;
    --line:#cbd5e1;
    --text:#0f172a;
    --muted:#64748b;
    --pri:#6366f1;
    --ok:#16a34a;
    --err:#dc2626;
    --warn:#d97706;
    --chip:#e2e8f0;
    --chipHover:#cbd5e1;
  }
  :root[data-theme="dark"]{
    --bg:#0e1625;
    --card:#14213b;
    --line:#2b3f66;
    --text:#f8fafc;
    --muted:#cbd5e1;
    --pri:#6d28d9;
    --ok:#10b981;
    --err:#ef4444;
    --warn:#f59e0b;
    --chip:#0b1220;
    --chipHover:#0f1a2e;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:1024px;margin:20px auto;padding:0 16px}
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    padding:18px;
    box-shadow:0 10px 25px rgba(15,23,42,.08);
  }
  h1{margin:0 0 4px;font-size:1.45rem}
  .muted{color:var(--muted)}

  .headerRow{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    flex-wrap:wrap;
  }

  .grid-info{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    margin:12px 0 6px;
  }
  @media (max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{
    background:rgba(148,163,184,.12);
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
  }
  .info b{
    display:block;
    margin-bottom:4px;
    color:var(--text);
  }

  /* ITENS */
  .item{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
    align-items:center;
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
    background:rgba(148,163,184,.08);
    margin-bottom:12px;
  }
  .stem{font-size:1rem}
  .scale{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
    gap:10px;
    justify-content:center;
  }

  /* Bot√µes de escolha */
  .choice{display:flex}
  .choice input{display:none}
  .choice span{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid var(--line);
    background:var(--chip);
    cursor:pointer;
    font-weight:600;
    text-align:center;
    width:100%;
    transition:transform .05s ease,border-color .15s ease,background .15s ease;
  }
  .choice:hover span{
    border-color:#4f70ff;
    background:var(--chipHover);
  }
  .choice input:checked + span{
    background:var(--pri);
    border-color:transparent;
    color:#fff;
    transform:translateY(-1px);
  }
  .choice span small{
    opacity:.9;
    font-weight:500;
    margin-left:6px;
  }

  .legend{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin:6px 0 12px;
  }
  .pill{
    display:inline-block;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(148,163,184,.16);
    font-size:.86rem;
  }

  /* A√ß√µes */
  .btn{
    display:inline-flex;
    align-items:center;
    gap:10px;
    background:var(--pri);
    border:none;
    color:#fff;
    padding:12px 16px;
    border-radius:12px;
    cursor:pointer;
    font-weight:600;
  }
  .btn.ok{background:var(--ok)}
  .btn.ghost{
    background:transparent;
    border:1px solid var(--line);
    color:var(--muted);
  }
  .btn.sm{
    padding:8px 12px;
    font-size:.85rem;
  }
  .btn:disabled{
    opacity:.6;
    cursor:not-allowed;
  }

  /* Mensagens */
  .msg{
    margin:12px 0;
    padding:12px;
    border-radius:10px;
  }
  .okbox{
    background:#ecfdf3;
    border:1px solid #16a34a33;
    color:#166534;
  }
  .errbox{
    background:#fef2f2;
    border:1px solid #dc262633;
    color:#b91c1c;
  }
  .warnbox{
    background:#fffbeb;
    border:1px solid #d9770633;
    color:#92400e;
  }

  /* Progresso */
  .progress{
    height:10px;
    background:rgba(148,163,184,.25);
    border:1px solid var(--line);
    border-radius:999px;
    overflow:hidden;
  }
  .bar{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,#6366f1,#10b981);
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="headerRow">
      <div>
        <h1>IHS2 ‚Äî Invent√°rio de Habilidades Sociais (Autorrelato)</h1>
        <p class="muted">
          Avalie <b>a frequ√™ncia</b> com que voc√™ age ou se sente como descrito em cada item, considerando um total de 38 ocasi√µes poss√≠veis.
        </p>
      </div>
      <button id="themeToggle" class="btn ghost sm" type="button" title="Alternar tema claro/escuro">
        üåô Modo escuro
      </button>
    </div>

    <div class="legend">
      <span class="pill">Nunca/Raramente</span>
      <span class="pill">Pouca frequ√™ncia</span>
      <span class="pill">Regular</span>
      <span class="pill">Muito frequente</span>
      <span class="pill">Sempre/Quase sempre</span>
    </div>

    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <div id="progressWrap" style="display:none; gap:8px; align-items:center; margin:8px 0 0;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
        <span class="muted" id="progressText">Progresso: 0/38</span>
        <button id="clearDraft" class="btn ghost" type="button" title="Limpar rascunho local">Limpar rascunho</button>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>

    <form id="form" style="margin-top:14px; display:none;" novalidate>
      <div id="qs"></div>
      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
        <button id="btnSave" class="btn ghost" type="button" title="Salvar rascunho">Salvar rascunho</button>
      </div>
      <div id="msg" class="msg" style="display:none" role="alert" aria-live="polite"></div>
    </form>

    <div id="alert" class="msg" style="display:none" role="alert" aria-live="assertive"></div>
  </div>
</div>

<script>
/* ===== UTIL B√ÅSICO ===== */
const $ = s => document.querySelector(s);

/* ===== TEMA CLARO/ESCURO ===== */
const THEME_KEY = "form_theme";

function getStoredTheme(){
  try{
    const t = localStorage.getItem(THEME_KEY);
    if(t==="dark" || t==="light") return t;
  }catch(_){}
  return "light";
}
function setStoredTheme(theme){
  try{ localStorage.setItem(THEME_KEY, theme); }catch(_){}
}
function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  setStoredTheme(theme);
  const btn = document.querySelector("#themeToggle");
  if(btn){
    btn.textContent = theme === "dark" ? "‚òÄÔ∏è Modo claro" : "üåô Modo escuro";
  }
}
// aplica tema inicial antes de tudo
(function initTheme(){
  const initial = getStoredTheme();
  document.documentElement.setAttribute("data-theme", initial);
})();

/* ===== CONFIG ===== */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_IHS2" };
const CODE = "IHS2";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
const RELEASE_KEYS = ["IHS2"]; // coluna de libera√ß√£o no Patients

/* ===== HELPERS ===== */
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";

function setBox(id, text, kind="ok"){
  const el=$(id); if(!el) return;
  el.textContent = text;
  el.className = "msg " + (kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox");
  el.style.display = "block";
}
function hideBox(id){
  const el=$(id); if(el){
    el.style.display="none";
    el.textContent="";
  }
}
function maskCPF(cpf){
  const d = onlyDigits(cpf||"");
  if(d.length!==11) return cpf||"";
  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;
}
function fmtDateISO(iso){
  if(!iso) return "";
  const [y,m,d] = String(iso).split("-");
  if(!y||!m||!d) return iso;
  return `${d}/${m}/${y}`;
}

async function GET(url){
  const r=await fetch(url);
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}
async function sheetSearch(sheet, params){
  const usp = new URLSearchParams(params);
  return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`);
}
async function sheetCreate(sheet, row){
  const r = await fetch(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ data:[row] })
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sheetPatchBy(sheet, column, value, data){
  const r = await fetch(
    `${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`,
    {
      method:"PATCH",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ data })
    }
  );
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
function goPortalWithToken(){
  try{
    const u = new URL(PORTAL_URL, location.href);
    if (TOKEN) u.searchParams.set("token", TOKEN);
    location.href = u.toString();
  }catch(_){
    const sep = PORTAL_URL.includes("?") ? "&" : "?";
    location.href = PORTAL_URL + (TOKEN ? sep + "token=" + encodeURIComponent(TOKEN) : "");
  }
}

/* ===== ITENS (38) ===== */
const ITEMS = [
  "1. Em um grupo de pessoas desconhecidas, fico √† vontade, conversando naturalmente.",
  "2. Quando um dos meus familiares insiste em dizer o que devo fazer, contrariando o que penso, acabo aceitando para evitar problemas.",
  "3. Ao ser elogiado(a) sinceramente por algu√©m, respondo-lhe agradecendo.",
  "4. Em uma conversa, se uma pessoa me interrompe, solicito que aguarde at√© eu encerrar o que eu estava dizendo.",
  "5. Quando um(a) amigo(a) a quem emprestei dinheiro esquece de me devolver, encontro um jeito de lembr√°-lo(a).",
  "6. Quando algu√©m faz algo que eu acho bom, mesmo que n√£o seja diretamente a mim, fa√ßo men√ß√£o a isso, elogiando-o(a) na primeira oportunidade.",
  "7. Ao sentir desejo de conhecer algu√©m a quem n√£o fui apresentado(a), eu mesmo(a) me apresento a essa pessoa.",
  "8. Mesmo junto a conhecidos da escola ou trabalho, encontro dificuldade em participar da conversa.",
  "9. Evito fazer exposi√ß√µes ou palestras a pessoas desconhecidas.",
  "10. Em minha casa, expresso sentimentos de carinho atrav√©s de palavras e gestos a meus familiares.",
  "11. Em uma sala de aula ou reuni√£o, se o professor ou dirigente faz uma afirma√ß√£o incorreta, eu exponho meu ponto de vista.",
  "12. Se estou interessado(a) em uma pessoa para relacionamento, consigo abord√°-la para iniciar uma conversa.",
  "13. No trabalho ou na escola, se algu√©m me faz um elogio, fico encabulado(a) sem saber o que dizer.",
  "14. Fa√ßo exposi√ß√£o (por exemplo, palestras) em sala de aula ou no trabalho quando sou indicado(a).",
  "15. Quando um familiar me critica injustamente, expresso meu aborrecimento diretamente a ele.",
  "16. Em um grupo de pessoas conhecidas, se n√£o concordo com a maioria, expresso verbalmente a minha discord√¢ncia.",
  "17. Em uma conversa com amigos, tenho dificuldade em encerrar a minha participa√ß√£o, preferindo aguardar que os outros o fa√ßam.",
  "18. Quando um de meus familiares, por algum motivo, me critica, reajo de forma agressiva.",
  "19. Mesmo pr√≥ximo(a) de uma pessoa importante, a quem gostaria de conhecer, tenho dificuldade em abord√°-la para iniciar uma conversa.",
  "20. Quando estou gostando de algu√©m com quem venho saindo, tomo a iniciativa de expressar-lhe meus sentimentos.",
  "21. Ao receber uma mercadoria com defeito, dirijo-me √† loja onde a comprei, exigindo a sua substitui√ß√£o.",
  "22. Ao ser solicitado(a) por um(a) colega para colocar seu nome em um trabalho feito sem a sua participa√ß√£o, acabo aceitando mesmo achando que n√£o devia.",
  "23. Evito fazer perguntas a pessoas desconhecidas.",
  "24. Tenho dificuldades em interromper uma conversa ao telefone, mesmo com pessoas desconhecidas.",
  "25. Quando sou criticado(a) de maneira direta e justa, consigo me controlar, admitindo meus erros ou explicando minha posi√ß√£o.",
  "26. Em campanhas de solidariedade, evito tarefas que envolvam pedir donativos ou favores a pessoas desconhecidas.",
  "27. Se um(a) amigo(a) abusa da minha boa vontade, expresso-lhe diretamente meu desagrado.",
  "28. Quando um dos meus familiares consegue alguma coisa importante pela qual se empenhou muito, eu o elogio pelo seu sucesso.",
  "29. Na escola ou no trabalho, quando n√£o compreendo uma explica√ß√£o sobre algo que estou interessado(a), fa√ßo as perguntas que julgo necess√°rias ao meu esclarecimento.",
  "30. Em uma situa√ß√£o de grupo, quando algu√©m √© injusti√ßado, reajo em sua defesa.",
  "31. Ao entrar em um ambiente onde est√£o v√°rias pessoas desconhecidas, cumprimento-as.",
  "32. Ao sentir que preciso de ajuda, tenho facilidade em pedi-la a algu√©m de meu c√≠rculo de amizades.",
  "33. Quando meu(minha) parceiro(a) insiste em fazer sexo sem o uso da camisinha, concordo para evitar que ele(a) fique irritado(a) ou magoado(a).",
  "34. No trabalho ou na escola, concordo em fazer tarefas que me pedem e que n√£o s√£o da minha obriga√ß√£o, mesmo sentindo um certo abuso nesses pedidos.",
  "35. Se estou me sentindo bem (feliz), expresso isso para as pessoas de meu c√≠rculo de amizades.",
  "36. Quando estou com uma pessoa que acabei de conhecer, sinto dificuldade em manter um papo interessante.",
  "37. Se preciso pedir um favor a um(a) colega, acabo desistindo de faz√™-lo.",
  "38. Consigo ‚Äúlevar na esportiva‚Äù as goza√ß√µes de colegas da escola ou do trabalho a meu respeito."
];

/* Labels 0‚Äì4 */
const LABELS = [
  "Nunca/Raramente",
  "Pouca frequ√™ncia",
  "Regular frequ√™ncia",
  "Muito frequente",
  "Sempre/Quase sempre"
];

/* ===== SUBSETS para C√ÅLCULOS ===== */
const TOTAL_ITEMS   = [1,3,6,7,10,11,12,15,16,20,25,27,28,29,30,31,35];
const F1_REVERSED   = [2,8,9,13,17,18,19,22,23,24,26,33,36]; // invertidos
const F2            = [7,12,20];
const F3            = [3,6,10,25,28,29,31,35];
const F4            = [11,15,16,27,30];
const F5_NORMAL     = [1,11,29,31];
const F5_REVERSED   = [9,19];

const inv5 = v => 4 - v; // invers√£o 0‚Üî4, 1‚Üî3, 2‚Üî2

/* ===== RENDER ===== */
function renderQuestions(){
  const host = $("#qs"); host.innerHTML = "";
  ITEMS.forEach((text, idx)=>{
    const q = idx+1, qn = String(q).padStart(2,"0");
    const row = document.createElement('div');
    row.className = 'item';
    row.setAttribute('data-q', String(q));

    const stem = document.createElement('div');
    stem.className = 'stem';
    stem.id = `s${qn}`;
    stem.textContent = text;

    const scale = document.createElement('div');
    scale.className = 'scale';

    LABELS.forEach((labTxt, val)=>{
      const lab = document.createElement('label');
      lab.className = 'choice';
      lab.innerHTML = `
        <input type="radio" name="q${qn}" value="${val}" required aria-labelledby="s${qn}">
        <span>${labTxt}<small></small></span>
      `;
      scale.appendChild(lab);
    });

    row.append(stem, scale);
    host.appendChild(row);
  });
}

/* ===== ESTADO ===== */
let patient=null, tokenRow=null, CPF="";
const TOKEN = qs("token");
const STORAGE_KEY = `IHS2_${TOKEN||'anon'}`;
let startAt = Date.now();

/* ===== BOOT ===== */
(async function boot(){
  try{
    if(!TOKEN){
      setBox("#alert","Link inv√°lido (sem token). Solicite um novo link.","err");
      return;
    }

    const trows = await sheetSearch(SHEETS.TOKENS, { token: TOKEN });
    if(!trows || !trows.length) throw new Error("Token inv√°lido ou expirado.");
    tokenRow = trows[0];

    if(String(tokenRow.disabled||"n√£o").toLowerCase()==="sim")
      throw new Error("Token desativado. Pe√ßa um novo link.");

    if(tokenRow.expires_at && new Date(tokenRow.expires_at) < new Date())
      throw new Error("Token expirado. Pe√ßa um novo link.");

    CPF = onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");

    const prows = await sheetSearch(SHEETS.PATIENTS, { cpf: CPF });
    if(!prows || !prows.length) throw new Error("Paciente n√£o encontrado.");
    patient = prows[0];

    const isAllowed = RELEASE_KEYS.some(k =>
      String(patient[k]||"").trim().toLowerCase()==="sim"
    );
    if(!isAllowed){
      setBox("#alert","Este formul√°rio n√£o est√° liberado para voc√™.","err");
      return;
    }

    // J√° respondeu?
    const doneKeys = RELEASE_KEYS.map(k => `${k}_FEITO`);
    const anyDoneFlag = doneKeys.some(k =>
      String(patient[k]||"").trim().toLowerCase()==="sim"
    );
    const already = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(anyDoneFlag || (already && already.length)){
      setBox("#alert","Voc√™ j√° respondeu este formul√°rio. Voltando ao portal‚Ä¶","ok");
      setTimeout(goPortalWithToken, 1200);
      return;
    }

    // Render
    renderPatientInfo();
    renderQuestions();
    restoreDraft();
    updateProgress();

    $("#pacInfo").style.display = "grid";
    $("#form").style.display = "block";
    $("#progressWrap").style.display = "block";
    hideBox("#alert");

    // in√≠cio para m√©trica de dura√ß√£o
    startAt = Date.now();

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formul√°rio. Tente novamente mais tarde.", "err");
  }
})();

function renderPatientInfo(){
  const g = $("#pacInfo"); g.innerHTML="";
  const info = [
    ["Nome", patient.nome || "-"],
    ["CPF", maskCPF(patient.cpf)]
  ];
  for(const [k,v] of info){
    const div = document.createElement("div");
    div.className = "info";
    div.innerHTML = `<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(div);
  }
}

/* ===== RASCUNHO LOCAL ===== */
function saveDraft(){
  const data = {};
  for(let i=1;i<=ITEMS.length;i++){
    const qn = String(i).padStart(2,"0");
    const sel = document.querySelector(`input[name="q${qn}"]:checked`);
    if(sel) data[`q${qn}`] = Number(sel.value);
  }
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }catch(e){
    console.warn("Sem espa√ßo para salvar rascunho");
  }
}
function restoreDraft(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    for(const [k,v] of Object.entries(data||{})){
      const el = document.querySelector(`input[name="${k}"][value="${v}"]`);
      if(el){ el.checked = true; }
    }
  }catch(e){ /* ignore */ }
}
function clearDraft(){
  try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
}

function countAnswered(){
  let c=0;
  for(let i=1;i<=ITEMS.length;i++){
    const qn=String(i).padStart(2,'0');
    if(document.querySelector(`input[name="q${qn}"]:checked`)) c++;
  }
  return c;
}
function updateProgress(){
  const answered = countAnswered();
  const total = ITEMS.length;
  $("#progressText").textContent = `Progresso: ${answered}/${total}`;
  $("#bar").style.width = `${(answered/total)*100}%`;
}

/* ===== EVENTOS DE UI ===== */
addEventListener('change', (e)=>{
  if(e.target && e.target.matches('input[type="radio"][name^="q"]')){
    saveDraft();
    updateProgress();
  }
});
$("#btnSave").addEventListener('click', ()=>{
  saveDraft();
  setBox('#msg','Rascunho salvo neste dispositivo.','ok');
});
$("#clearDraft").addEventListener('click', ()=>{
  clearDraft();
  setBox('#msg','Rascunho apagado.','warn');
});

/* ===== UTIL PARA ESCORES E QUESTIONS ===== */
function sumSet(indices, transform){
  let s = 0;
  for(const i of indices){
    const qn = String(i).padStart(2,'0');
    const sel = document.querySelector(`input[name="q${qn}"]:checked`);
    const val = sel ? Number(sel.value) : 0;
    s += transform ? transform(val) : val;
  }
  return s;
}

// mapa bruto { "01": 2, "02": 4, ... }
function collectAnswersMap(){
  const ans = {};
  for(let i=1;i<=ITEMS.length;i++){
    const qn = String(i).padStart(2,"0");
    const sel = document.querySelector(`input[name="q${qn}"]:checked`);
    ans[qn] = sel ? Number(sel.value) : null;
  }
  return ans;
}

// vers√£o leg√≠vel para PDF/App Script
// { "01": { stem:"...", value:2, label:"Pouca frequ√™ncia" }, ... }
function collectQuestionsReadable(){
  const obj = {};
  for(let i=1;i<=ITEMS.length;i++){
    const qn = String(i).padStart(2,"0");
    const fullText = ITEMS[i-1] || "";
    const cleanText = fullText.replace(/^\d+\.\s*/, "");
    const sel = document.querySelector(`input[name="q${qn}"]:checked`);
    if(sel){
      const valNum = Number(sel.value);
      const lbl = LABELS[valNum] || "";
      obj[qn] = { stem: cleanText, label: lbl };
    }else{
      obj[qn] = { stem: cleanText, label: "" };
    }
  }
  return obj;
}

/* ===== SUBMIT ===== */
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(sending) return;
  sending = true;
  hideBox("#msg");

  const btn = $("#btnSubmit");
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = "Enviando‚Ä¶";

  try{
    if(!patient) throw new Error("Sess√£o inv√°lida. Recarregue o link.");

    // Valida√ß√£o: todas respondidas
    const missing = [];
    let firstMissingRow = null;
    for(let i=1;i<=ITEMS.length;i++){
      const qn = String(i).padStart(2,'0');
      const sel = document.querySelector(`input[name="q${qn}"]:checked`);
      if(!sel){
        missing.push(i);
        if(!firstMissingRow){
          firstMissingRow = document.querySelector(`.item[data-q="${i}"]`);
        }
      }
    }
    if(missing.length){
      if(firstMissingRow){
        firstMissingRow.scrollIntoView({behavior:'smooth', block:'center'});
      }
      throw new Error(`Voc√™ ainda n√£o respondeu os itens: ${missing.join(", ")}.`);
    }

    // Seguran√ßa extra: checar se j√° foi enviado
    const again = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(again && again.length){
      setBox("#msg","Este formul√°rio j√° foi enviado anteriormente. Voltando ao portal‚Ä¶","ok");
      setTimeout(goPortalWithToken, 1100);
      return;
    }

    // C√°lculos de escore
    const total = sumSet(TOTAL_ITEMS);

    const F1  = sumSet(F1_REVERSED, inv5);
    const F2s = sumSet(F2);
    const F3s = sumSet(F3);
    const F4s = sumSet(F4);
    const F5s = sumSet(F5_NORMAL) + sumSet(F5_REVERSED, inv5);

    const categoria_csv = [
      `total=${total}`,
      `F1=${F1}`,
      `F2=${F2s}`,
      `F3=${F3s}`,
      `F4=${F4s}`,
      `F5=${F5s}`
    ].join(',');

    // M√©tricas detalhadas + perguntas/respostas em JSON
    const answersMap = collectAnswersMap();
    const questionsReadable = collectQuestionsReadable();
    const durationSec = Math.round((Date.now() - startAt)/1000);

    const metricsObj = {
      sums: {
        
        F1,
        F2: F2s,
        F3: F3s,
        F4: F4s,
        F5: F5s,
        total
      },
      duration_sec: durationSec,
      answers: answersMap,
      answers_readable: questionsReadable
    };

    await sheetCreate(SHEETS.SCORES, {
      result_id: `${patient.cpf}_${CODE}_${Date.now()}`,
      token: TOKEN,
      cpf: patient.cpf,
      code: CODE,
      source: "paciente",
      submitted_at: new Date().toISOString(),
      total: total,
      categoria: categoria_csv,
      metrics: "",
      questions: JSON.stringify(questionsReadable)
    });

    // Marca como feito
    const doneUpdates = {};
    RELEASE_KEYS.map(k=>`${k}_FEITO`).forEach(k=>{
      if(k in patient) doneUpdates[k] = "sim";
    });
    if(Object.keys(doneUpdates).length===0){
      doneUpdates[`${RELEASE_KEYS[0]}_FEITO`] = "sim";
    }
    await sheetPatchBy(SHEETS.PATIENTS, "cpf", patient.cpf, doneUpdates);

    clearDraft();
    setBox("#msg","Formul√°rio enviado. Voltando ao portal‚Ä¶","ok");
    setTimeout(goPortalWithToken, 1100);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending = false;
    btn.disabled = false;
    btn.textContent = originalText;
  }
});

/* ===== TEMA: BOT√ÉO TOGGLE ===== */
const themeBtn = $("#themeToggle");
if(themeBtn){
  const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
  applyTheme(currentTheme);
  themeBtn.addEventListener("click", ()=>{
    const now = document.documentElement.getAttribute("data-theme") || "light";
    const next = (now === "dark") ? "light" : "dark";
    applyTheme(next);
  });
}

/* ===== DEV CHECKS ===== */
(function devChecks(){
  if(ITEMS.length !== 38){
    console.warn(`ITEMS possui ${ITEMS.length} itens, esperado 38.`);
  }
  const max = ITEMS.length;
  const all = new Set([
    ...TOTAL_ITEMS,
    ...F1_REVERSED,
    ...F2,
    ...F3,
    ...F4,
    ...F5_NORMAL,
    ...F5_REVERSED
  ]);
  for(const i of all){
    if(i<1 || i>max) console.warn('√çndice fora do range:', i);
  }
})();
</script>
</body>
</html>
