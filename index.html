<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>IHS2 — Inventário de Habilidades Sociais</title>
<style>
  :root{
    --bg:#0e1625; --card:#14213b; --line:#2b3f66;
    --text:#f8fafc; --muted:#cbd5e1;
    --pri:#6d28d9; --ok:#10b981; --err:#ef4444; --warn:#f59e0b;
    --chip:#0b1220; --chipHover:#0f1a2e;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:1024px;margin:20px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{margin:0 0 6px;font-size:1.45rem}
  .muted{color:var(--muted)}

  .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0 6px}
  @media (max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:12px;padding:12px}
  .info b{display:block;margin-bottom:4px;color:#e2e8f0}

  /* ===== ITENS ===== */
  .item{
    display:grid;grid-template-columns:1fr;gap:12px;align-items:center;
    border:1px solid var(--line);border-radius:12px;padding:12px;
    background:rgba(0,0,0,.18);margin-bottom:12px
  }
  .stem{font-size:1rem}
  .scale{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
    gap:10px;justify-content:center
  }

  /* Botões de escolha */
  .choice{display:flex}
  .choice input{display:none}
  .choice span{
    display:inline-flex;align-items:center;justify-content:center;
    padding:10px 12px;border-radius:10px;border:1px solid var(--line);
    background:var(--chip);cursor:pointer;font-weight:600;
    text-align:center; width:100%;
    transition:transform .05s ease,border-color .15s ease,background .15s ease
  }
  .choice:hover span{border-color:#4f70ff;background:var(--chipHover)}
  .choice input:checked + span{background:var(--pri);border-color:transparent;color:#fff;transform:translateY(-1px)}
  .choice span small{opacity:.9;font-weight:500;margin-left:6px}

  .legend{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 12px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.25);font-size:.86rem}

  /* Ações */
  .btn{display:inline-flex;align-items:center;gap:10px;background:var(--pri);border:none;color:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600}
  .btn.ok{background:var(--ok)}
  .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--muted)}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  /* Mensagens */
  .msg{margin:12px 0;padding:12px;border-radius:10px}
  .okbox{background:#06351f;border:1px solid #0e6c45;color:#c8ffe3}
  .errbox{background:#3b0d0d;border:1px solid #7f1d1d;color:#ffd5d5}
  .warnbox{background:#3a2903;border:1px solid #885e09;color:#ffe6b0}

  /* Progresso */
  .progress{height:10px;background:rgba(255,255,255,.05);border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg, #6d28d9, #10b981)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>IHS2 — Inventário de Habilidades Sociais (Autorrelato)</h1>
    <p class="muted">
      Avalie <b>a frequência</b> com que você age ou se sente como descrito em cada item, considerando um total de 38 ocasiões possíveis.
    </p>
    <div class="legend">
      <span class="pill">Nunca/Raramente</span>
      <span class="pill">Pouca frequência</span>
      <span class="pill">Regular</span>
      <span class="pill">Muito frequente</span>
      <span class="pill">Sempre/Quase sempre</span>
    </div>

    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <div id="progressWrap" style="display:none; gap:8px; align-items:center; margin:8px 0 0;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
        <span class="muted" id="progressText">Progresso: 0/38</span>
        <button id="clearDraft" class="btn ghost" type="button" title="Limpar rascunho local">Limpar rascunho</button>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>

    <form id="form" style="margin-top:14px; display:none;" novalidate>
      <div id="qs"></div>
      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
        <button id="btnSave" class="btn ghost" type="button" title="Salvar rascunho">Salvar rascunho</button>
      </div>
      <div id="msg" class="msg" style="display:none" role="alert" aria-live="polite"></div>
    </form>

    <div id="alert" class="msg" style="display:none" role="alert" aria-live="assertive"></div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_IHS2" };
const CODE = "IHS2";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
const RELEASE_KEYS = ["IHS2"]; // coluna de liberação no Patients

/* ===== HELPERS ===== */
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
function setBox(id, text, kind="ok"){
  const el=$(id); if(!el) return;
  el.textContent = text;
  el.className = "msg " + (kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox");
  el.style.display = "block";
}
function hideBox(id){
  const el=$(id); if(el){
    el.style.display="none";
    el.textContent="";
  }
}
function maskCPF(cpf){
  const d = onlyDigits(cpf||"");
  if(d.length!==11) return cpf||"";
  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;
}
function fmtDateISO(iso){
  if(!iso) return "";
  const [y,m,d] = iso.split("-");
  if(!y||!m||!d) return iso;
  return `${d}/${m}/${y}`;
}
async function GET(url){
  const r=await fetch(url);
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}
async function sheetSearch(sheet, params){
  const usp = new URLSearchParams(params);
  return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`);
}
async function sheetCreate(sheet, row){
  const r = await fetch(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ data:[row] })
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sheetPatchBy(sheet, column, value, data){
  const r = await fetch(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`, {
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ data })
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
function goPortalWithToken(){
  try{
    const u = new URL(PORTAL_URL, location.href);
    u.searchParams.set("token", TOKEN);
    location.href = u.toString();
  }catch(_){
    const sep = PORTAL_URL.includes("?") ? "&" : "?";
    location.href = PORTAL_URL + sep + "token=" + encodeURIComponent(TOKEN);
  }
}

/* ===== ITENS (38) ===== */
const ITEMS = [
  "1. Em um grupo de pessoas desconhecidas, fico à vontade, conversando naturalmente.",
  "2. Quando um dos meus familiares insiste em dizer o que eu devo fazer, contrariando o que penso, acabo aceitando para evitar problemas.",
  "3. Ao ser elogiado(a) sinceramente por alguém, respondo-lhe agradecendo.",
  "4. Em uma conversa, se uma pessoa me interrompe, solicito que aguarde até eu encerrar o que eu estava dizendo.",
  "5. Quando um(a) amigo(a) a quem emprestei dinheiro esquece de me devolver, encontro um jeito de lembrá-lo(a).",
  "6. Quando alguém faz algo que eu acho bom, mesmo que não seja diretamente a mim, faço menção a isso, elogiando-o(a) na primeira oportunidade.",
  "7. Ao sentir desejo de conhecer alguém a quem não fui apresentado(a), eu mesmo(a) me apresento a essa pessoa.",
  "8. Mesmo junto a conhecidos da escola ou trabalho, encontro dificuldade em participar da conversa.",
  "9. Evito fazer exposições ou palestras a pessoas desconhecidas.",
  "10. Em minha casa, expresso sentimentos de carinho através de palavras e gestos a meus familiares.",
  "11. Em uma sala de aula ou reunião, se o professor ou dirigente faz uma afirmação incorreta, eu exponho meu ponto de vista.",
  "12. Se estou interessado(a) em uma pessoa para relacionamento, consigo abordá-la para iniciar uma conversa.",
  "13. No trabalho ou na escola, se alguém me faz um elogio, fico encabulado(a) sem saber o que dizer.",
  "14. Faço exposição (por exemplo, palestras) em sala de aula ou no trabalho quando sou indicado(a).",
  "15. Quando um familiar me critica injustamente, expresso meu aborrecimento diretamente a ele.",
  "16. Em um grupo de pessoas conhecidas, se não concordo com a maioria, expresso verbalmente a minha discordância.",
  "17. Em uma conversa com amigos, tenho dificuldade em encerrar a minha participação, preferindo aguardar que os outros o façam.",
  "18. Quando um de meus familiares, por algum motivo, me critica, reajo de forma agressiva.",
  "19. Mesmo próximo(a) de uma pessoa importante, a quem gostaria de conhecer, tenho dificuldade em abordá-la para iniciar uma conversa.",
  "20. Quando estou gostando de alguém com quem venho saindo, tomo a iniciativa de expressar-lhe meus sentimentos.",
  "21. Ao receber uma mercadoria com defeito, dirijo-me à loja onde a comprei, exigindo a sua substituição.",
  "22. Ao ser solicitado(a) por um(a) colega para colocar seu nome em um trabalho feito sem a sua participação, acabo aceitando mesmo achando que não devia.",
  "23. Evito fazer perguntas a pessoas desconhecidas.",
  "24. Tenho dificuldades em interromper uma conversa ao telefone, mesmo com pessoas desconhecidas.",
  "25. Quando sou criticado(a) de maneira direta e justa, consigo me controlar, admitindo meus erros ou explicando minha posição.",
  "26. Em campanhas de solidariedade, evito tarefas que envolvam pedir donativos ou favores a pessoas desconhecidas.",
  "27. Se um(a) amigo(a) abusa da minha boa vontade, expresso-lhe diretamente meu desagrado.",
  "28. Quando um dos meus familiares consegue alguma coisa importante pela qual se empenhou muito, eu o elogio pelo seu sucesso.",
  "29. Na escola ou no trabalho, quando não compreendo uma explicação sobre algo que estou interessado(a), faço as perguntas que julgo necessárias ao meu esclarecimento.",
  "30. Em uma situação de grupo, quando alguém é injustiçado, reajo em sua defesa.",
  "31. Ao entrar em um ambiente onde estão várias pessoas desconhecidas, cumprimento-as.",
  "32. Ao sentir que preciso de ajuda, tenho facilidade em pedi-la a alguém de meu círculo de amizades.",
  "33. Quando meu(minha) parceiro(a) insiste em fazer sexo sem o uso da camisinha, concordo para evitar que ele(a) fique irritado(a) ou magoado(a).",
  "34. No trabalho ou na escola, concordo em fazer tarefas que me pedem e que não são da minha obrigação, mesmo sentindo um certo abuso nesses pedidos.",
  "35. Se estou me sentindo bem (feliz), expresso isso para as pessoas de meu círculo de amizades.",
  "36. Quando estou com uma pessoa que acabei de conhecer, sinto dificuldade em manter um papo interessante.",
  "37. Se preciso pedir um favor a um(a) colega, acabo desistindo de fazê-lo.",
  "38. Consigo “levar na esportiva” as gozações de colegas da escola ou do trabalho a meu respeito."
];

/* Labels 0–4 (mesma ordem dos radio buttons) */
const LABELS = [
  "Nunca/Raramente",
  "Pouca frequência",
  "Regular frequência",
  "Muito frequente",
  "Sempre/Quase sempre"
];

/* ===== SUBSETS para CÁLCULOS ===== */
/* Atenção: alguns fatores envolvem inversão */
const TOTAL_ITEMS = [1,3,6,7,10,11,12,15,16,20,25,27,28,29,30,31,35]; // Soma direta
const F1_REVERSED = [2,8,9,13,17,18,19,22,23,24,26,33,36];             // F1 é soma após inversão
const F2 = [7,12,20];                                                  // F2 soma direta
const F3 = [3,6,10,25,28,29,31,35];                                    // F3 soma direta
const F4 = [11,15,16,27,30];                                           // F4 soma direta
const F5_NORMAL = [1,11,29,31];                                        // F5 = normais + invertidos
const F5_REVERSED = [9,19];

const inv5 = v => 4 - v; // inversão 0↔4, 1↔3, 2↔2

/* ===== RENDER ===== */
function renderQuestions(){
  const host = $("#qs"); host.innerHTML = "";
  ITEMS.forEach((text, idx)=>{
    const q = idx+1, qn = String(q).padStart(2,"0");
    const row = document.createElement('div');
    row.className = 'item';
    row.setAttribute('data-q', String(q));

    const stem = document.createElement('div');
    stem.className = 'stem';
    stem.id = `s${qn}`;
    stem.textContent = text;

    const scale = document.createElement('div');
    scale.className = 'scale';

    LABELS.forEach((labTxt, val)=>{
      const lab = document.createElement('label');
      lab.className = 'choice';
      lab.innerHTML = `
        <input type="radio" name="q${qn}" value="${val}" required aria-labelledby="s${qn}">
        <span>${labTxt}<small></small></span>
      `;
      scale.appendChild(lab);
    });

    row.append(stem, scale);
    host.appendChild(row);
  });
}

/* ===== ESTADO ===== */
let patient=null, tokenRow=null, CPF="";
const TOKEN = qs("token");
const STORAGE_KEY = `IHS2_${TOKEN||'anon'}`;

/* ===== BOOT ===== */
(async function boot(){
  try{
    if(!TOKEN){
      setBox("#alert","Link inválido (sem token). Solicite um novo link.","err");
      return;
    }

    const trows = await sheetSearch(SHEETS.TOKENS, { token: TOKEN });
    if(!trows || !trows.length) throw new Error("Token inválido ou expirado.");
    tokenRow = trows[0];
    if(String(tokenRow.disabled||"não").toLowerCase()==="sim") throw new Error("Token desativado. Peça um novo link.");
    if(tokenRow.expires_at && new Date(tokenRow.expires_at) < new Date()) throw new Error("Token expirado. Peça um novo link.");
    CPF = onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");

    const prows = await sheetSearch(SHEETS.PATIENTS, { cpf: CPF });
    if(!prows || !prows.length) throw new Error("Paciente não encontrado.");
    patient = prows[0];

    const isAllowed = RELEASE_KEYS.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    if(!isAllowed){
      setBox("#alert","Este formulário não está liberado para você.","err");
      return;
    }

    // Já respondeu?
    const doneKeys = RELEASE_KEYS.map(k => `${k}_FEITO`);
    const anyDoneFlag = doneKeys.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    const already = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(anyDoneFlag || (already && already.length)){
      setBox("#alert","Você já respondeu este formulário. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken, 1200);
      return;
    }

    // Render
    renderPatientInfo();
    renderQuestions();
    restoreDraft();
    updateProgress();

    $("#pacInfo").style.display = "grid";
    $("#form").style.display = "block";
    $("#progressWrap").style.display = "block";
    hideBox("#alert");

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formulário. Tente novamente mais tarde.", "err");
  }
})();

function renderPatientInfo(){
  const g = $("#pacInfo"); g.innerHTML="";
  const info = [
    ["Nome", patient.nome || "-"],
    ["CPF", maskCPF(patient.cpf)]
  ];
  for(const [k,v] of info){
    const div = document.createElement("div");
    div.className = "info";
    div.innerHTML = `<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(div);
  }
}

/* ===== RASCUNHO LOCAL ===== */
function saveDraft(){
  const data = {};
  for(let i=1;i<=ITEMS.length;i++){
    const qn = String(i).padStart(2,"0");
    const sel = document.querySelector(`input[name="q${qn}"]:checked`);
    if(sel) data[`q${qn}`] = Number(sel.value);
  }
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }catch(e){
    console.warn("Sem espaço para salvar rascunho");
  }
}
function restoreDraft(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    for(const [k,v] of Object.entries(data||{})){
      const el = document.querySelector(`input[name="${k}"][value="${v}"]`);
      if(el){ el.checked = true; }
    }
  }catch(e){ /* ignore */ }
}
function clearDraft(){ localStorage.removeItem(STORAGE_KEY); }

function countAnswered(){
  let c=0;
  for(let i=1;i<=ITEMS.length;i++){
    const qn=String(i).padStart(2,'0');
    if(document.querySelector(`input[name="q${qn}"]:checked`)) c++;
  }
  return c;
}
function updateProgress(){
  const answered = countAnswered();
  const total = ITEMS.length;
  $("#progressText").textContent = `Progresso: ${answered}/${total}`;
  $("#bar").style.width = `${(answered/total)*100}%`;
}

/* ===== EVENTOS DE UI ===== */
addEventListener('change', (e)=>{
  if(e.target && e.target.matches('input[type="radio"][name^="q"]')){
    saveDraft();
    updateProgress();
  }
});
$("#btnSave").addEventListener('click', ()=>{
  saveDraft();
  setBox('#msg','Rascunho salvo neste dispositivo.','ok');
});
$("#clearDraft").addEventListener('click', ()=>{
  clearDraft();
  setBox('#msg','Rascunho apagado.','warn');
});

/* ===== UTIL ===== */
function sumSet(indices, transform){
  let s = 0;
  for(const i of indices){
    const qn = String(i).padStart(2,'0');
    const sel = document.querySelector(`input[name="q${qn}"]:checked`);
    const val = sel ? Number(sel.value) : 0;
    s += transform ? transform(val) : val;
  }
  return s;
}

/* ===== SUBMIT ===== */
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(sending) return;
  sending = true;
  hideBox("#msg");

  const btn = $("#btnSubmit");
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = "Enviando…";

  try{
    if(!patient) throw new Error("Sessão inválida. Recarregue o link.");

    // Validação: todas respondidas
    for(let i=1;i<=ITEMS.length;i++){
      const qn = String(i).padStart(2,'0');
      const sel = document.querySelector(`input[name="q${qn}"]:checked`);
      if(!sel){
        const row = document.querySelector(`.item[data-q="${i}"]`);
        if(row) row.scrollIntoView({behavior:'smooth', block:'center'});
        throw new Error(`Responda a questão ${i}.`);
      }
    }

    // Montar perguntas+respostas marcadas para salvar em 'questions'
    const qaList = [];
for (let i = 1; i <= ITEMS.length; i++) {
  const qn = String(i).padStart(2, "0");
  const sel = document.querySelector(`input[name="q${qn}"]:checked`);
  const rawVal = Number(sel.value);
  
  // pega o texto e remove o "1. ", "2. " etc
  const fullText = ITEMS[i - 1];
  const cleanText = fullText.replace(/^\d+\.\s*/, "");

  const answerLabel = LABELS[rawVal] || "";
  qaList.push(`${cleanText}: ${answerLabel}`);
}

    // Cálculos de escore
    const total = sumSet(TOTAL_ITEMS); // escore total definido (só itens específicos)

    const F1 = sumSet(F1_REVERSED, inv5);
    const F2s = sumSet(F2);
    const F3s = sumSet(F3);
    const F4s = sumSet(F4);
    const F5s = sumSet(F5_NORMAL) + sumSet(F5_REVERSED, inv5);

    const categoria_csv = [
      `total=${total}`,
      `F1=${F1}`,
      `F2=${F2s}`,
      `F3=${F3s}`,
      `F4=${F4s}`,
      `F5=${F5s}`
    ].join(',');

    await sheetCreate(SHEETS.SCORES, {
      result_id: `${patient.cpf}_${CODE}_${Date.now()}`,
      token: TOKEN,
      cpf: patient.cpf,
      code: CODE,
      source: "paciente",
      submitted_at: new Date().toISOString(),
      total: total,
      categoria: categoria_csv,
       metrics: "",
      questions: JSON.stringify(qaList)
     
    });

    // Marca como feito
    const doneUpdates = {};
    RELEASE_KEYS.map(k=>`${k}_FEITO`).forEach(k=>{
      if(k in patient) doneUpdates[k] = "sim";
    });
    if(Object.keys(doneUpdates).length===0){
      doneUpdates[`${RELEASE_KEYS[0]}_FEITO`] = "sim";
    }
    await sheetPatchBy(SHEETS.PATIENTS, "cpf", patient.cpf, doneUpdates);

    clearDraft();
    setBox("#msg","Formulário enviado. Voltando ao portal…","ok");
    setTimeout(goPortalWithToken, 1100);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending = false;
    btn.disabled = false;
    btn.textContent = originalText;
  }
});

/* ===== DEV CHECKS ===== */
(function devChecks(){
  if(ITEMS.length !== 38){
    console.warn(`ITEMS possui ${ITEMS.length} itens, esperado 38.`);
  }
  const max = ITEMS.length;
  const all = new Set([
    ...TOTAL_ITEMS,
    ...F1_REVERSED,
    ...F2,
    ...F3,
    ...F4,
    ...F5_NORMAL,
    ...F5_REVERSED
  ]);
  for(const i of all){
    if(i<1 || i>max) console.warn('Índice fora do range:', i);
  }
})();
</script>
</body>
</html>
